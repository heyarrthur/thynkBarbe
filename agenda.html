<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>thynkBarber • Agenda (Barbeiro)</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              25:'#f8faff',50:'#f3f7ff',100:'#e6efff',200:'#d8e6ff',300:'#b9d0ff',
              400:'#93b4ff',500:'#4a82ff',600:'#3a6af4',700:'#2e54c6',800:'#2746a3',900:'#203a85'
            }
          },
          boxShadow:{ soft:'0 1px 2px rgba(16,24,40,.04), 0 6px 18px rgba(16,24,40,.08)' },
          borderRadius:{ '2xl':'1rem' },
          keyframes:{
            fadeUp:{ from:{opacity:0, transform:'translateY(6px)'}, to:{opacity:1, transform:'translateY(0)'} },
            slideIn:{ from:{transform:'translateX(100%)'}, to:{transform:'translateX(0)'} }
          },
          animation:{ fadeUp:'fadeUp .28s ease both', slideIn:'slideIn .25s ease both' }
        }
      }
    }
  </script>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    *{ box-sizing:border-box }
    html, body{ overflow-x:hidden; background:#fff }
    .no-scrollbar::-webkit-scrollbar{ display:none }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    /* Fix tap targets on mobile */
    .tap{ min-height:44px; min-width:44px }
  </style>
</head>
<body class="bg-white text-slate-800">

  <!-- TOPBAR (mobile) -->
  <header class="lg:hidden sticky top-0 z-50 bg-white/80 backdrop-blur border-b">
    <div class="flex items-center gap-2 p-3">
      <button id="openSidebar" class="tap p-2 rounded-xl border hover:bg-slate-50" aria-label="Abrir menu">
        <i class="bi bi-list"></i>
      </button>
      <div class="font-medium">Agenda</div>
      <div class="ml-auto text-xs px-2 py-1 rounded bg-slate-100">Light</div>
    </div>
  </header>

  <div class="flex">
    <!-- SIDEBAR (desktop fixa) -->
    <aside class="hidden lg:flex lg:fixed lg:inset-y-0 lg:left-0 lg:w-72 border-r bg-white z-40">
      <div class="flex-1 flex flex-col">
        <div class="px-5 py-5 border-b flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-brand-600 text-white grid place-items-center font-bold">tb</div>
          <div>
            <div class="font-bold">thynkBarber</div>
            <div class="text-xs text-slate-500">Painel do Barbeiro</div>
          </div>
        </div>
        <nav class="px-3 py-3 text-sm overflow-y-auto">
          <div class="px-3 py-2 text-slate-400 uppercase tracking-wide">Administrativo</div>
          <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-speedometer2"></i><span>Dashboard</span>
          </a>

          <div class="px-3 pt-4 pb-2 text-slate-400 uppercase tracking-wide">Agendamentos</div>
          <a href="agenda.html" class="flex items-center gap-3 px-3 py-2 rounded-xl bg-brand-50 text-brand-800 border border-brand-100">
            <i class="bi bi-calendar3"></i><span>Agenda</span>
          </a>
          <a href="historico.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-clock-history"></i><span>Histórico</span>
          </a>

          <div class="px-3 pt-4 pb-2 text-slate-400 uppercase tracking-wide">Finanças</div>
          <a href="faturamento.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-wallet2"></i><span>Faturamento</span>
          </a>
          <a href="metas.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-bullseye"></i><span>Metas</span>
          </a>
          <a href="vendas.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-bag"></i><span>Vendas</span>
          </a>

          <div class="px-3 pt-4 pb-2 text-slate-400 uppercase tracking-wide">Perfil</div>
          <div class="mx-3 p-3 border rounded-xl bg-slate-50">
            <div class="text-xs text-slate-500">Barbeiro</div>
            <div id="barberName" class="font-medium">—</div>
          </div>
        </nav>
      </div>
    </aside>

    <!-- SIDEBAR (mobile offcanvas) -->
    <div id="sidebarSheet" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/40" data-close-sheet></div>
      <div class="absolute left-0 top-0 h-full w-[92%] max-w-[340px] bg-white border-r shadow-xl animate-slideIn">
        <div class="flex items-center justify-between px-4 py-4 border-b">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-brand-600 text-white grid place-items-center font-bold">tb</div>
            <div class="font-semibold">thynkBarber</div>
          </div>
          <button class="tap p-2 rounded-xl border hover:bg-slate-50" data-close-sheet aria-label="Fechar">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <nav class="p-3 text-sm">
          <div class="px-3 py-2 text-slate-400 uppercase tracking-wide">Administrativo</div>
          <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-speedometer2"></i><span>Dashboard</span>
          </a>
          <div class="px-3 pt-4 pb-2 text-slate-400 uppercase tracking-wide">Agendamentos</div>
          <a href="agenda.html" class="flex items-center gap-3 px-3 py-2 rounded-xl bg-brand-50 text-brand-800 border border-brand-100">
            <i class="bi bi-calendar3"></i><span>Agenda</span>
          </a>
          <a href="historico.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-clock-history"></i><span>Histórico</span>
          </a>
          <div class="px-3 pt-4 pb-2 text-slate-400 uppercase tracking-wide">Finanças</div>
          <a href="faturamento.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-wallet2"></i><span>Faturamento</span>
          </a>
          <a href="metas.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-bullseye"></i><span>Metas</span>
          </a>
          <a href="vendas.html" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
            <i class="bi bi-bag"></i><span>Vendas</span>
          </a>
        </nav>
      </div>
    </div>

    <!-- MAIN -->
    <main class="flex-1 min-h-screen lg:ml-72">
      <!-- CONTROLES (mobile sticky) -->
      <div class="lg:hidden sticky top-[49px] z-40 bg-white border-b">
        <div class="flex items-center gap-2 p-2">
          <button id="mPrev" class="tap p-2 rounded-xl border hover:bg-slate-50" aria-label="Dia anterior"><i class="bi bi-chevron-left"></i></button>
          <button id="mToday" class="tap p-2 rounded-xl border hover:bg-slate-50" aria-label="Hoje"><i class="bi bi-calendar3"></i></button>
          <div id="mobileDateLabel" class="flex-1 text-center font-medium">—</div>
          <button id="mNext" class="tap p-2 rounded-xl border hover:bg-slate-50" aria-label="Próximo dia"><i class="bi bi-chevron-right"></i></button>
        </div>
      </div>

      <!-- WEEK STRIP (8 dias / 4 por página) -->
      <section class="border-b bg-white">
        <div class="px-3 lg:px-6 py-3 flex items-center gap-2">
          <button id="daysPrev" class="tap p-2 rounded-xl border hover:bg-slate-50" aria-label="Voltar 4 dias"><i class="bi bi-chevron-left"></i></button>
          <div id="weekStrip" class="grid grid-cols-4 gap-2 flex-1"></div>
          <button id="daysNext" class="tap p-2 rounded-xl border hover:bg-slate-50" aria-label="Avançar 4 dias"><i class="bi bi-chevron-right"></i></button>
        </div>
        <div class="px-3 lg:px-6 pb-3 text-xs text-slate-500">Visualizando próximos 8 dias (navegação 4/4).</div>
      </section>

      <!-- FILTROS -->
      <section class="px-3 lg:px-6 py-3 border-b bg-white">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
          <input id="searchClient" class="col-span-2 md:col-span-2 border rounded-xl px-3 py-2 text-sm" placeholder="Buscar cliente…" />
          <select id="filterService" class="border rounded-xl px-3 py-2 text-sm">
            <option value="">Todos os serviços</option>
          </select>
          <select id="filterStatus" class="border rounded-xl px-3 py-2 text-sm">
            <option value="">Todos os status</option>
            <option value="scheduled">Agendado</option>
            <option value="confirmed">Confirmado</option>
            <option value="done">Concluído</option>
            <option value="noshow">No-show</option>
            <option value="canceled">Cancelado</option>
          </select>
          <button id="clearFilters" class="px-3 py-2 border rounded-xl text-sm"><i class="bi bi-x-circle me-1"></i>Limpar</button>
        </div>
      </section>

      <!-- CONTEÚDO: Lista do dia (mobile-first) -->
      <section class="p-3 lg:p-6">
        <div class="p-3 md:p-4 border rounded-2xl bg-white shadow-soft">
          <div class="flex items-center justify-between">
            <div class="font-medium">Agendamentos do dia</div>
            <div id="dayLabel" class="text-xs text-slate-500">—</div>
          </div>
          <div id="dayList" class="mt-3 space-y-2"></div>
          <!-- RESUMO DO DIA -->
          <div id="daySummary" class="mt-4 hidden">
            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-slate-500"><i class="bi bi-clipboard-check me-1"></i> Total</div>
                <div id="sumCount" class="font-semibold">0 agendamentos</div>
              </div>
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-emerald-700"><i class="bi bi-check2-circle me-1"></i> Concluídos</div>
                <div id="sumDone" class="font-semibold">0</div>
              </div>
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-brand-800"><i class="bi bi-calendar-check me-1"></i> Confirmados</div>
                <div id="sumConfirmed" class="font-semibold">0</div>
              </div>
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-rose-700"><i class="bi bi-x-circle me-1"></i> Cancelados</div>
                <div id="sumCanceled" class="font-semibold">0</div>
              </div>
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-amber-700"><i class="bi bi-dash-circle me-1"></i> No-show</div>
                <div id="sumNoShow" class="font-semibold">0</div>
              </div>
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-slate-500"><i class="bi bi-hourglass-split me-1"></i> Tempo total</div>
                <div id="sumDuration" class="font-semibold">0 min</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="p-3 border rounded-xl bg-brand-50 border-brand-100">
                <div class="text-xs text-brand-800"><i class="bi bi-cash-stack me-1"></i> Receita prevista</div>
                <div id="sumProjected" class="text-lg font-semibold">R$ 0,00</div>
              </div>
              <div class="p-3 border rounded-xl">
                <div class="text-xs text-slate-500"><i class="bi bi-wallet2 me-1"></i> Receita recebida</div>
                <div id="sumReceived" class="text-lg font-semibold">R$ 0,00</div>
              </div>
            </div>
          </div>
          <div id="emptyState" class="hidden p-6 text-center text-slate-500 border rounded-2xl">Nenhum agendamento para este dia.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- SHEET DETALHES DO CLIENTE/APPT -->
  <div id="apptSheet" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/40" data-close-sheet2></div>
    <div class="absolute right-0 top-0 h-full w-full sm:w-[520px] bg-white shadow-xl flex flex-col rounded-l-2xl animate-slideIn">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <div class="font-semibold">Detalhes do Agendamento</div>
        <button class="tap p-2 rounded-xl border hover:bg-slate-50" data-close-sheet2 aria-label="Fechar"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="flex-1 overflow-y-auto p-4" id="sheetContent"></div>
      <div class="border-t p-3 flex gap-2 bg-white">
        <button class="px-3 py-2 border rounded-xl" data-close-sheet2>Fechar</button>
      </div>
    </div>
  </div>

  <!-- =================== JS =================== -->
  <script>
    /* ======= API (AJAX-ready) ======= */
    const API = {
      async getServices(barberId){
        try{ const r = await fetch(`/api/barbers/${barberId}/services`); if(!r.ok) throw 0; return await r.json(); }catch{ return SERVICES; }
      },
      async getAppointments(barberId, from, to){
        try{ const r = await fetch(`/api/barbers/${barberId}/appointments?from=${from}&to=${to}`); if(!r.ok) throw 0; return await r.json(); }
        catch{ return APPOINTMENTS.filter(a=> a.date>=from && a.date<=to); }
      },
      async getClient(id){
        try{ const r = await fetch(`/api/clients/${id}`); if(!r.ok) throw 0; return await r.json(); }catch{ return CLIENTS.find(c=>c.id===id) }
      }
    };

    /* ======= Mock (fallback) ======= */
    const BARBER = { id: 'b1', name: 'Carlos Silva' };
    const SERVICES = [
      { id: 'cut', name: 'Corte', duration: 40, price: 55, color:'#4a82ff' },
      { id: 'beard', name: 'Barba', duration: 30, price: 40, color:'#22c55e' },
      { id: 'combo', name: 'Combo Corte + Barba', duration: 70, price: 85, color:'#f59e0b' },
      { id: 'color', name: 'Coloração', duration: 50, price: 120, color:'#ef4444' },
    ];
    const CLIENTS = [
      { id:'c1', name:'João Pedro', phone:'+55 11 90000-0001', member:true, since:'2024-04-12', visits:['2025-08-11','2025-08-28','2025-09-15','2025-10-01'], purchases:[{product:'Pomada Modeladora', date:'2025-09-23', price:49.9}], habits:['Corte a cada 3 semanas','Prefere máquina #1'], notes:'Gosta de degradê baixo.' },
      { id:'c2', name:'Matheus Lima', phone:'+55 11 90000-0002', member:false, since:'2023-11-01', visits:['2025-07-05','2025-09-10'], purchases:[], habits:['Barba quinzenal'], notes:'Sensível na pele do pescoço.' },
      { id:'c3', name:'Rafael Souza', phone:'+55 11 90000-0003', member:true, since:'2022-06-20', visits:['2025-06-01','2025-07-01','2025-08-01','2025-09-01'], purchases:[{product:'Óleo para Barba', date:'2025-08-02', price:39.9}], habits:['Combo mensal'], notes:'' },
    ];

    // Hoje -> próximos 7 dias (8 dias no total)
    const TODAY = new Date('2025-10-15T12:00:00');
    let APPOINTMENTS = [
      { id:'a1', clientId:'c1', serviceId:'cut',  date:'2025-10-15', start:'09:00', duration:40, status:'done', notes:'', paid:55 },
      { id:'a2', clientId:'c2', serviceId:'beard',date:'2025-10-15', start:'10:00', duration:30, status:'confirmed', notes:'Barba com toalha quente', paid:0 },
      { id:'a3', clientId:'c3', serviceId:'combo',date:'2025-10-16', start:'11:00', duration:70, status:'scheduled', notes:'Fidelidade', paid:0 },
      { id:'a4', clientId:'c1', serviceId:'color',date:'2025-10-18', start:'15:30', duration:50, status:'scheduled', notes:'', paid:0 },
      { id:'a5', clientId:'c1', serviceId:'cut',  date:'2025-10-19', start:'17:00', duration:40, status:'scheduled', notes:'', paid:0 },
      { id:'a6', clientId:'c2', serviceId:'cut',  date:'2025-10-20', start:'09:15', duration:40, status:'scheduled', notes:'', paid:0 },
      { id:'a7', clientId:'c3', serviceId:'beard',date:'2025-10-21', start:'14:00', duration:30, status:'canceled', notes:'Remarcado', paid:0 },
      { id:'a8', clientId:'c2', serviceId:'beard',date:'2025-10-22', start:'10:30', duration:30, status:'noshow', notes:'Não atendeu', paid:0 }
    ];

    /* ======= Estado & Utils ======= */
    let currentDate = new Date(TODAY);
    let dayPagerIndex = 0; // 0: dias 0..3 | 1: dias 4..7

    const $ = sel => document.querySelector(sel);
    const pad = n=> String(n).padStart(2,'0');
    const fmtDateISO = d=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISO = s=> { const [Y,M,D] = s.split('-').map(Number); return new Date(Y, M-1, D) };
    const addDays = (d,n)=> { const x=new Date(d); x.setDate(x.getDate()+n); return x };
    const addMinutes = (time, minutes)=> { const [h,m]=time.split(':').map(Number); const t=h*60+m+minutes; return `${pad(Math.floor(t/60))}:${pad(t%60)}` };
    const currency = v=> v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});

    /* ======= Sidebar mobile ======= */
    $('#openSidebar')?.addEventListener('click', ()=> $('#sidebarSheet').classList.remove('hidden'));
    document.querySelectorAll('[data-close-sheet]').forEach(b=> b.addEventListener('click', ()=> $('#sidebarSheet').classList.add('hidden')));

    /* ======= Week strip (próximos 8 dias / 4 por página) ======= */
    function renderWeekStrip(){
      const cont = $('#weekStrip'); cont.innerHTML='';
      const daysAhead = Array.from({length:8}, (_,i)=> addDays(TODAY, i)); // 0..7 dias à frente
      const start = dayPagerIndex*4; const slice = daysAhead.slice(start, start+4);
      slice.forEach(d=>{
        const iso = fmtDateISO(d); const isActive = iso===fmtDateISO(currentDate);
        const btn = document.createElement('button');
        btn.className = `rounded-2xl border w-full py-3 ${isActive?'bg-brand-50 border-brand-200 text-brand-900 shadow-soft':'hover:bg-slate-50'}`;
        btn.innerHTML = `<div class='text-[10px] uppercase text-slate-500'>${d.toLocaleDateString('pt-BR',{weekday:'short'})}</div><div class='font-semibold'>${pad(d.getDate())}/${pad(d.getMonth()+1)}</div>`;
        btn.addEventListener('click',()=>{ currentDate=d; syncDateControls(); renderAll();});
        const cell = document.createElement('div'); cell.className='col-span-1'; cell.appendChild(btn); cont.appendChild(cell);
      });
      $('#daysPrev').disabled = dayPagerIndex===0;
      $('#daysNext').disabled = dayPagerIndex===1;
    }
    $('#daysPrev')?.addEventListener('click', ()=>{ if(dayPagerIndex>0){ dayPagerIndex--; renderWeekStrip(); }});
    $('#daysNext')?.addEventListener('click', ()=>{ if(dayPagerIndex<1){ dayPagerIndex++; renderWeekStrip(); }});

    /* ======= Controles de data ======= */
    function syncDateControls(){
      $('#mobileDateLabel') && ($('#mobileDateLabel').textContent = currentDate.toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit', month:'2-digit'}));
      $('#dayLabel').textContent = currentDate.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'2-digit', year:'numeric' });
    }
    $('#mToday')?.addEventListener('click', ()=>{ currentDate = new Date(TODAY); syncDateControls(); renderAll(); });
    $('#mPrev')?.addEventListener('click', ()=>{ const min=new Date(TODAY); if(currentDate>min){ currentDate=addDays(currentDate,-1); if(dayPagerIndex===1 && (currentDate - TODAY) < (4*86400000)) dayPagerIndex=0; } syncDateControls(); renderAll(); });
    $('#mNext')?.addEventListener('click', ()=>{ const max=addDays(TODAY,7); if(currentDate<max){ currentDate=addDays(currentDate,1); if(dayPagerIndex===0 && (currentDate - TODAY) >= (4*86400000)) dayPagerIndex=1; } syncDateControls(); renderAll(); });

    /* ======= Filtros ======= */
    const filterService = $('#filterService');
    const filterStatus = $('#filterStatus');
    const searchClient = $('#searchClient');
    [filterService, filterStatus, searchClient].forEach(el=> el && el.addEventListener('input', renderDay));
    $('#clearFilters')?.addEventListener('click', ()=>{ searchClient.value=''; filterService.value=''; filterStatus.value=''; renderDay(); });

    /* ======= Dados ======= */
    const getClient = id => CLIENTS.find(c=> c.id===id);
    const getService = id => SERVICES.find(s=> s.id===id);

    function getForDay(date){
      const iso = fmtDateISO(date);
      let list = APPOINTMENTS.filter(a=> a.date===iso);
      if(filterService?.value) list = list.filter(a=> a.serviceId===filterService.value);
      if(filterStatus?.value) list = list.filter(a=> a.status===filterStatus.value);
      if(searchClient?.value){ const q=searchClient.value.toLowerCase(); list=list.filter(a=> getClient(a.clientId).name.toLowerCase().includes(q)); }
      list.sort((a,b)=> a.start.localeCompare(b.start));
      return list;
    }

    /* ======= UI helpers ======= */
    function statusPill(st){
      if(st==='done') return "bg-emerald-50 text-emerald-800 border-emerald-200";
      if(st==='confirmed') return "bg-brand-50 text-brand-800 border-brand-200";
      if(st==='scheduled') return "bg-slate-50 text-slate-700 border-slate-200";
      if(st==='canceled') return "bg-rose-50 text-rose-800 border-rose-200";
      if(st==='noshow') return "bg-amber-50 text-amber-800 border-amber-200";
      return "bg-slate-50 text-slate-700 border-slate-200";
    }

    /* ======= Resumo do dia ======= */
    function renderDaySummary(list){
      const el = document.getElementById('daySummary');
      if(!list || list.length===0){ el.classList.add('hidden'); return }
      el.classList.remove('hidden');
      const sum = { total:list.length, done:0, confirmed:0, canceled:0, noshow:0, duration:0, projected:0, received:0 };
      list.forEach(a=>{
        sum.duration += a.duration||0;
        if(a.status==='done') sum.done++;
        else if(a.status==='confirmed') sum.confirmed++;
        else if(a.status==='canceled') sum.canceled++;
        else if(a.status==='noshow') sum.noshow++;
        const s = (typeof getService==='function') ? getService(a.serviceId) : null;
        const price = a.paid>0 ? a.paid : (s? s.price: 0);
        sum.projected += (s? s.price: 0);
        sum.received  += (a.paid||0);
      });
      document.getElementById('sumCount').textContent = `${sum.total} agendamentos`;
      document.getElementById('sumDone').textContent = sum.done;
      document.getElementById('sumConfirmed').textContent = sum.confirmed;
      document.getElementById('sumCanceled').textContent = sum.canceled;
      document.getElementById('sumNoShow').textContent = sum.noshow;
      document.getElementById('sumDuration').textContent = `${sum.duration} min`;
      document.getElementById('sumProjected').textContent = currency(sum.projected);
      document.getElementById('sumReceived').textContent = currency(sum.received);
    }

    /* ======= Render ======= */
    function renderDay(){
      const cont = $('#dayList'); cont.innerHTML='';
      const list = getForDay(currentDate);
      $('#emptyState').classList.toggle('hidden', list.length>0);
      if(list.length===0){ renderDaySummary([]); return; }

      list.forEach((a,i)=>{
        const c=getClient(a.clientId); const s=getService(a.serviceId); const end=addMinutes(a.start,a.duration);
        const row=document.createElement('div'); row.className='p-3 border rounded-2xl bg-white shadow-soft animate-fadeUp'; row.style.animationDelay=`${i*0.03}s`;
        row.innerHTML = `
          <div class='flex items-center justify-between'>
            <div class='text-xs text-slate-500'>${a.start} - ${end} • ${a.duration} min</div>
            <span class='px-2 py-0.5 text-xs rounded-xl border ${statusPill(a.status)}'>${
              a.status==='done'?'Concluído': a.status==='confirmed'?'Confirmado': a.status==='scheduled'?'Agendado': a.status==='canceled'?'Cancelado':'No-show'
            }</span>
          </div>
          <div class='mt-2 flex items-center gap-3'>
            <div class='w-10 h-10 rounded-full grid place-items-center text-brand-800 border' style='background:rgba(74,130,255,.08); border-color:rgba(74,130,255,.25)'>${c.name.split(' ').map(p=>p[0]).slice(0,2).join('')}</div>
            <div class='min-w-0'>
              <div class='font-medium truncate'>${c.name} ${c.member?`<span class='ml-2 px-2 py-0.5 text-[11px] rounded-xl bg-brand-50 text-brand-800 border border-brand-100'>Assinante</span>`:''}</div>
              <div class='text-sm text-slate-500'>${s.name}</div>
            </div>
            <div class='ml-auto text-right'>
              <div class='text-sm'>${a.paid? currency(a.paid) : currency(s.price)}</div>
              <button class='mt-1 px-2 py-1 rounded-xl border hover:bg-slate-50 text-xs' data-open='${a.id}'><i class='bi bi-eye me-1'></i>Ver</button>
            </div>
          </div>`;
        cont.appendChild(row);
      });

      document.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', ()=> openAppt(b.getAttribute('data-open'))));
      renderDaySummary(list);
    }

    /* ======= Sheet Detalhes ======= */
    const sheet = $('#apptSheet');
    function openAppt(id){
      const a = APPOINTMENTS.find(x=> x.id===id); const c = CLIENTS.find(x=> x.id===a.clientId); const s = SERVICES.find(x=> x.id===a.serviceId);
      const end = addMinutes(a.start,a.duration);
      const visitsPerMonth = (()=>{ const months=new Set(c.visits.map(v=> v.slice(0,7))); return (c.visits.length/Math.max(months.size,1)).toFixed(1) })();
      const lastPurchase = c.purchases && c.purchases[0]? c.purchases[c.purchases.length-1]: null;
      const lastVisited = c.visits && c.visits.length? c.visits[c.visits.length-1] : null;

      $('#sheetContent').innerHTML = `
        <div class='flex items-center gap-3'>
          <div class='w-12 h-12 rounded-full grid place-items-center text-brand-800 border' style='background:rgba(74,130,255,.08); border-color:rgba(74,130,255,.25)'>${c.name.split(' ').map(p=>p[0]).slice(0,2).join('')}</div>
          <div>
            <div class='font-semibold'>${c.name} ${c.member?`<span class=\"ml-2 px-2 py-0.5 text-xs rounded-xl bg-brand-50 text-brand-800 border border-brand-100\">Assinante</span>`:''}</div>
            <div class='text-xs text-slate-500'>${c.phone||'—'}</div>
          </div>
          <span class='ml-auto px-2 py-0.5 text-xs rounded-xl border ${statusPill(a.status)}'>${
            a.status==='done'?'Concluído': a.status==='confirmed'?'Confirmado': a.status==='scheduled'?'Agendado': a.status==='canceled'?'Cancelado':'No-show'
          }</span>
        </div>
        <div class='grid grid-cols-2 gap-3 mt-3'>
          <div class='p-3 border rounded-xl'><div class='text-xs text-slate-500'>Data</div><div class='font-medium'>${a.date.split('-').reverse().join('/')}</div></div>
          <div class='p-3 border rounded-xl'><div class='text-xs text-slate-500'>Horário</div><div class='font-medium'>${a.start} - ${end}</div></div>
          <div class='col-span-2 p-3 border rounded-xl'><div class='text-xs text-slate-500'>Serviço</div><div class='font-medium'><span class='inline-block w-2 h-2 rounded-full mr-2' style='background:${s.color}'></span>${s.name} <span class='text-slate-500'>• ${a.duration} min</span></div></div>
          <div class='col-span-2 p-3 border rounded-xl'><div class='text-xs text-slate-500'>Valor</div><div class='font-semibold'>${a.paid? currency(a.paid) : currency(s.price)}</div></div>
        </div>
        <div class='grid grid-cols-2 gap-3 mt-3'>
          <div class='p-3 border rounded-xl'><div class='text-xs text-slate-500'>Primeira visita</div><div class='font-medium'>${(c.since||'—').split('-').reverse().join('/')}</div></div>
          <div class='p-3 border rounded-xl'><div class='text-xs text-slate-500'>Última visita</div><div class='font-medium'>${lastVisited? lastVisited.split('-').reverse().join('/'):'—'}</div></div>
          <div class='p-3 border rounded-xl col-span-2'><div class='text-xs text-slate-500'>Frequência média</div><div class='font-medium'>${visitsPerMonth}x/mês</div></div>
        </div>
        <div class='p-3 border rounded-xl mt-3'>
          <div class='text-sm font-medium mb-2'>Compras de produtos</div>
          ${ lastPurchase ? `<div class='text-sm'><i class='bi bi-bag me-1'></i>${lastPurchase.product} • ${lastPurchase.date.split('-').reverse().join('/')} • ${currency(lastPurchase.price)}</div>` : `<div class='text-sm text-slate-500'>Nenhuma compra registrada.</div>` }
        </div>
        <div class='p-3 border rounded-xl mt-3'>
          <div class='text-sm font-medium mb-2'>Costumes / Preferências</div>
          <div class='flex flex-wrap gap-2'>${ (c.habits||[]).map(h=> `<span class="px-2 py-0.5 text-xs rounded-xl border bg-slate-50">${h}</span>`).join('') || '<span class="text-sm text-slate-500">—</span>' }</div>
        </div>
        <div class='p-3 border rounded-xl mt-3'>
          <div class='text-sm font-medium mb-2'>Observações</div>
          <div class='text-sm'>${a.notes || c.notes || '—'}</div>
        </div>`;
      sheet.classList.remove('hidden');
      document.querySelectorAll('[data-close-sheet2]').forEach(b=> b.onclick = ()=> sheet.classList.add('hidden'));
    }

    /* ======= Init ======= */
    function loadServiceFilters(){
      const sel = document.getElementById('filterService');
      SERVICES.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); });
    }
    function renderAll(){ renderWeekStrip(); renderDay(); }
    function init(){
      document.getElementById('barberName').textContent = BARBER.name;
      loadServiceFilters();
      syncDateControls();
      // Ajustar pager conforme data (0..3 | 4..7)
      const diffDays = Math.floor((currentDate - TODAY)/(1000*60*60*24));
      dayPagerIndex = diffDays>=4 ? 1 : 0;
      renderAll();
    }
    init();
  </script>
</body>
</html>
